---
title: "Main Linear Model Analysis"
author: "Sho"
date: "11/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


# Loading in Data 

Loading as done by Seokjun. 

```{r}
data <- read.csv("MH_survey_only_higher_index.csv",
    na.strings = "NA")
names(data)
#only relevant for Seokjun's PC
names(data)[1] <- "gender"

data <- data[, -c(17:22)]


# Assigning factors
data$gender <- factor(data$gender)
data$age_group <- factor(data$age_group)
data$country_lockdown <- factor(data$country_lockdown)
data$marital <- factor(data$marital)
data$smoking <- factor(data$smoking)
data$fivfruitveg <- factor(data$fivfruitveg)
data$shielded <- factor(data$shielded)
data$week_soc_distancing <- factor(data$week_soc_distancing)
data$athlete <- factor(data$athlete)
```



# Step-wise Regression 

Here we conduct the step-wise regression using step. 
Note for Seokjun: `step` actually terminates at a different point if you take out missing data. 
This is an issue. 

The final model is pretty different than what we had before. 

```{r}
data_without_na <- data[complete.cases(data), ]
model_full <- lm(MHC_SF_OVERALL ~ ., data = data_without_na)
summary(model_full)

step(model_full, direction = "backward")
```


This is the model that results through the `step` function. 

```{r}
model_step9 = lm(formula = MHC_SF_OVERALL ~ gender + age_group + week_soc_distancing + 
    athlete + HADS_OVERALL + RES_TOTAL + LONE_TOTAL, data = data_without_na)
model_step9  %>% summary()
```


# Removing variables with Collinearity Issues: RES & HADS 
Determine which variable to remove (due to collinearity issue: RES or HADS):

```{r}
no_HADS = lm(formula = MHC_SF_OVERALL ~ gender + age_group + week_soc_distancing + 
    athlete+ RES_TOTAL + LONE_TOTAL, data = data_without_na)

no_RES = lm(formula = MHC_SF_OVERALL ~ gender + age_group + week_soc_distancing + 
    athlete + HADS_OVERALL + LONE_TOTAL, data = data_without_na)

paste0("AIC without HADS: ", c(no_HADS %>% extractAIC())[2] %>% round(2))
paste0("AIC without RES: ", c(no_RES %>% extractAIC())[2] %>% round(2))
```

AIC is significantly lower without RES. For the final model, we will remove RES. 


# Final Model 

```{r}
final_model = lm(formula = MHC_SF_OVERALL ~ gender + age_group + week_soc_distancing + 
    athlete + HADS_OVERALL + LONE_TOTAL, data = data_without_na)
final_model %>% summary()
```



```{r fig.width=8, fig.height=5}
par(mfrow = c(2, 2))
plot(final_model)
```

Residual plots look almost perfect!  We will look at the outliers below. 
Potential homoskedasticity? 


# Outlier Analysis

```{r}
plot(final_model, which = 4)
```

The outlier point is unusual in terms of weeks social distancing and the maximum LONE score (very lonely).  
No Cook's distance is above 1 (or 0.5) so even the large points (296, 341, and 405) are not concerning. 

```{r}
final_model$model[c(296, 341, 405), ]

```

Compare this to the overall data: 

```{r}
final_model$model %>% summary()
```

Comment: not obvious to me why these are outliers (but it is hard when there are so many variables).



# Testing All Interactions

Here we run the F-Test on all secondary interactions.  It returned a small F statistic and high p-value. 
This is good news!  Less LaTeX work. 

```{r}
model_interaction = lm(formula = MHC_SF_OVERALL ~ (gender + age_group + week_soc_distancing + 
    athlete + HADS_OVERALL + + LONE_TOTAL)^2, data = data_without_na)
anova(final_model, model_interaction)
```


# F-Test for Model Significance + T-test for continuous/two-category variables

This can be done just via the `summary` function. 

```{r}
final_model %>% summary()
anova(final_model) #type 1
# explanation: https://stats.stackexchange.com/questions/20452/how-to-interpret-type-i-type-ii-and-type-iii-anova-and-manova/20455#20455
library(car)
Anova(final_model) #type 2
```


```{r}
w.o.gender = lm(formula = MHC_SF_OVERALL ~ age_group + week_soc_distancing + 
    athlete + HADS_OVERALL + LONE_TOTAL, data = data_without_na)
anova( w.o.gender, final_model)
```


Gender & Athlete are both significant at 0.05. 
HADS, LONE are also significant.  We will now do F-test on `age_group` and `week_soc_distancing`. 

First with age_group 
```{r}
w.o.age_group = lm(formula = MHC_SF_OVERALL ~ gender + week_soc_distancing + 
    athlete + HADS_OVERALL + LONE_TOTAL, data = data_without_na)
anova(final_model, w.o.age_group)
```

Significant at 0.05

Now with `week_soc_distancing`:


```{r}
w.o.week_soc_dist = lm(formula = MHC_SF_OVERALL ~ gender + age_group + 
    athlete + HADS_OVERALL + LONE_TOTAL, data = data_without_na)
anova(final_model, w.o.week_soc_dist)
```


Significant at 0.001!    


# Other Plots 

other residual plots

```{r}
par(mfrow = c(1, 1))
# vs fitted
plot(final_model$residuals ~ final_model$fitted.values)
abline(h = 0)

#vs predictors
plot(final_model$residuals ~ data_without_na$gender)
plot(final_model$residuals ~ data_without_na$age_group)
plot(final_model$residuals ~ data_without_na$week_soc_distancing)  # <- hmm
plot(final_model$residuals ~ data_without_na$athlete)
plot(final_model$residuals ~ data_without_na$HADS_OVERALL)
abline(h = 0)
plot(final_model$residuals ~ data_without_na$LONE_TOTAL)
abline(h = 0)

```


```{r}
final_model
```



```{r fig.height=5, fig.width=8}
library(car)
avPlots(final_model, terms=~HADS_OVERALL + LONE_TOTAL)
```





#Seokjun Comments on Next Steps
comment (nov 27 1:30 am): 

First of all, thanks Sho!

I think next thing to do is

1. delete HAD or RES (because of Collinearity) <- we can do this right after 'step' function result

    Sho: Done, compared using AIC. Chose HAD. 

2. Draw diagnosis plot (residual, normal qq, leverage, ... using 'plot(lm_fit_object)', 
    Sho: Done. 
    
    Delete outlier/other annoying points.
    
    Sho: Did not do yet .
    
    Please make a figure to show an outlier if it exists.
    
    Sho: Done?
    
    And, if there are variance problem (heteroskedasticity or ...), stop and rest (let's discuss together)

3. re-fit lm (after deleting things in 1 and 2)
    
    Sho: Did not remove any outliers but removed HADS to create `final_model`. 
    
4. basic test: F test for model significance(first!) -> 
    t test for continuous variable, model comparison F-test (for each categorical variable group)
    
    Sho: Done.
    
5. visualize fitting result (if we can. if it is too high dimention, just make a table). See R^2/AIC/BIC,...
    
    Sho: Tried... 

6. residual analysis (same as 2)
    
    Sho: not yet?

7. if we want: make prediction example?
    
    Sho: Not yet
    
8. Tested all interaction terms (secondary) <---- Added 

   Sho: no terms were significant.  

(I think) By Tuesday, we don't have to finish writing everything, but
just 4,5,6(+7) steps table and figure is enough.

Let's write together. Don't write it all alone! I'll help you

And, please give me an idea to visualize the Lasso fit. 
After making 2 plots, I don't know what to do.

